ARTEFACT start
  DEPENDS ON ../..+dev

ARTEFACT stop
  DEPENDS ON ../../+dev-stop

DOCKERFILE go
  FILE
    FROM scratch
    COPY db-operator /db-operator
    ENTRYPOINT [ "/db-operator" ]
  IGNORE
    !db-operator

ARTEFACT image
  STEP build
    COMMAND
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/db-operator ./main.go

  STEP image
    DOCKERFILE go
    TAG db-operator
    CONTEXT ./dist

DOCKERFILE integration
  FILE
    FROM scratch
    COPY db-operator-tests /db-operator-tests
    ENTRYPOINT [ "/db-operator-tests" ]
    CMD [ "-test.v" ]
  IGNORE
    !db-operator-tests

ARTEFACT integration
  STEP build
    COMMAND
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go test -c -o dist/db-operator-tests ./integration

  STEP image
    DOCKERFILE integration
    TAG db-operator-tests
    CONTEXT ./dist

ARTEFACT test
  STEP test
    COMMAND
      go test -p=1 -v ./internal/...