FROM ../../libraries/images/golang+image

deps:
  COPY go.mod go.sum ./
  RUN go mod download

  COPY --dir internal pkg .

test:
  FROM +deps

  COPY docker-compose.yaml docker-compose.yaml

  WITH DOCKER --compose docker-compose.yaml
    RUN CGO_ENABLED=0 \
      GOOS=linux \
      GOARCH=amd64 \
      DB_HOST=localhost \
      DB_USER=root \
      go test ./cmd/...
  END

module:
  FROM +deps

  SAVE ARTIFACT ./*