init:
    FROM ekidd/rust-musl-builder

    WORKDIR /home/rust/src

    RUN cargo init --name auth-operator --bin
    RUN ls

    SAVE ARTIFACT Cargo.toml AS LOCAL Cargo.toml

deps:
    FROM ekidd/rust-musl-builder

    WORKDIR /home/rust/src

docker:
    FROM scratch

    SAVE IMAGE auth-operator

cluster:
    LOCALLY

    RUN k3d cluster create auth-operator \
      --registry-create \
      --k3s-server-arg "--no-deploy=traefik" \
      --kubeconfig-update-default=false \
      -p "80:80@loadbalancer" \
      --wait

    RUN mkdir -p .scratch \
        && k3d kubeconfig get auth-operator > .scratch/kubeconfig \
        && KUBECONFIG=.scratch/kubeconfig kubectl config use-context k3d-auth-operator

stop:
    LOCALLY

    RUN k3d cluster delete auth-operator \
        && rm -rf .scratch