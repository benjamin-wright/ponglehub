FROM golang:1.16
WORKDIR /workspace

builder:
    COPY go.mod go.mod
    COPY go.sum go.sum

    RUN go mod download

    COPY main.go main.go
    COPY api/ api/
    COPY controllers/ controllers/

    RUN --mount=type=cache,target=/root/.cache/go-build \
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o manager main.go

    SAVE ARTIFACT manager

manager:
    FROM gcr.io/distroless/static:nonroot

    WORKDIR /
    COPY +builder/manager manager
    USER 65532:65532

    ENTRYPOINT ["/manager"]

    SAVE IMAGE auth-operator

cluster:
    LOCALLY

    RUN k3d cluster create auth-operator \
      --registry-create \
      --k3s-server-arg "--no-deploy=traefik" \
      --kubeconfig-update-default=false \
      -p "80:80@loadbalancer" \
      --wait

    RUN mkdir -p .scratch \
        && k3d kubeconfig get auth-operator > .scratch/kubeconfig \
        && KUBECONFIG=.scratch/kubeconfig kubectl config use-context k3d-auth-operator

stop:
    LOCALLY

    RUN k3d cluster delete auth-operator \
        && rm -rf .scratch