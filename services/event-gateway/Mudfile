ARTEFACT start
  DEPENDS ON ../..+start

ARTEFACT stop
  DEPENDS ON ../../+stop

DOCKERFILE go
  FILE
    FROM scratch
    COPY event-gateway /event-gateway
    COPY templates /html
    ENTRYPOINT [ "/event-gateway" ]
  IGNORE
    !event-gateway

ARTEFACT image
  STEP build
    COMMAND
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/event-gateway ./main.go
    
  STEP copy-templates
    COMMAND
      rm -rf ./dist/templates
      cp -r ./templates ./dist/templates

  STEP image
    DOCKERFILE go
    TAG localhost:5000/event-gateway
    CONTEXT ./dist

ARTEFACT test
  STEP test
    COMMAND
      go test -v ./internal/...

ARTEFACT int-test
  STEP test
    COMMAND
      go test -count 1 -v ./integration