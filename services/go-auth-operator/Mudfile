ARTEFACT start
  DEPENDS ON ../..+dev

ARTEFACT stop
  DEPENDS ON ../../+dev-stop

DOCKERFILE go
  FILE
    FROM scratch
    COPY auth-operator /auth-operator
    ENTRYPOINT [ "/auth-operator" ]

ARTEFACT image
  STEP build
    COMMAND
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/auth-operator ./main.go

  STEP image
    DOCKERFILE go
    TAG auth-operator
    CONTEXT ./dist

DOCKERFILE go-test
  FILE
    FROM scratch
    COPY auth-operator-tests /auth-operator-tests
    ENTRYPOINT [ "/auth-operator-tests" ]

ARTEFACT test-image
  STEP build
    COMMAND
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go test -c -o dist/auth-operator-tests ./

  STEP image
    DOCKERFILE go-test
    TAG auth-operator-tests
    CONTEXT ./dist