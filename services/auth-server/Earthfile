FROM golang:1.16

WORKDIR /src

deps:
  COPY go.mod go.sum ./
  RUN go mod download

  COPY *.go ./
  COPY internal ./internal
  COPY cmd ./cmd

build-userlist:
  FROM +deps

  RUN --mount=type=cache,target=/root/.cache CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o userlist  ./cmd/userlist

  SAVE ARTIFACT userlist

docker-userlist:
  FROM scratch

  COPY +build-userlist/userlist /go/bin/userlist
  ENTRYPOINT [ "/go/bin/userlist" ]

  SAVE IMAGE userlist