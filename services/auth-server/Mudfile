ARTEFACT start
  DEPENDS ON ../../+dev-cluster

ARTEFACT stop
  DEPENDS ON ../../+stop

ARTEFACT deps
  STEP download
    COMMAND go mod download

ARTEFACT test
  DEPENDS ON +deps
  DEPENDS ON ../../libraries/mudfiles/cockroachdb+certs

  STEP test
    DEVENV ../../libraries/mudfiles/cockroachdb db
    COMMAND
      POSTGRES_HOST=localhost \
      POSTGRES_PORT=26257 \
      POSTGRES_USER=test_user \
      POSTGRES_PASS=test_password \
      POSTGRES_ADMIN_USER=root \
      POSTGRES_CERTS=$(pwd)/../../libraries/mudfiles/ssl/certs \
      go test -p=1 -v ./cmd/...

DOCKERFILE go
  FILE
    FROM scratch
    ARG APP
    COPY ./$APP /entrypoint
    ENTRYPOINT [ "/entrypoint" ]

ARTEFACT migrations
  DEPENDS ON +deps
  
  STEP build
    COMMAND
      mkdir -p dist
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/migrations ./cmd/migrations/main.go
  STEP image
    DOCKERFILE go
    CONTEXT dist
    ARG APP=migrations
    TAG localhost:5000/auth-server-migrations

ARTEFACT events
  DEPENDS ON +deps

  STEP build
    COMMAND
      mkdir -p dist
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/events ./cmd/events/main.go
  STEP image
    DOCKERFILE go
    CONTEXT dist
    ARG APP=events
    TAG localhost:5000/auth-server-events

ARTEFACT server
  DEPENDS ON +deps

  STEP server-build
    COMMAND
      mkdir -p dist
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
        go build -v -o dist/server ./cmd/server/main.go
  STEP server-image
    DOCKERFILE go
    CONTEXT dist
    ARG APP=server
    TAG localhost:5000/auth-server

ARTEFACT images
  DEPENDS ON +migrations
  DEPENDS ON +events
  DEPENDS ON +server
  