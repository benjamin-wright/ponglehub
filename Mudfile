ENV CLUSTER_NAME=pongle
ENV REGISTRY_NAME=pongle-registry.localhost
ENV REGISTRY_PORT=5000

ARTEFACT start
  STEP registry
    CONDITION ! k3d registry list | grep -w k3d-$REGISTRY_NAME 
    COMMAND k3d registry create $REGISTRY_NAME --port $REGISTRY_PORT
  
  STEP cluster
    CONDITION ! k3d cluster list | grep -w $CLUSTER_NAME
    COMMAND
      k3d cluster create $CLUSTER_NAME \
        --registry-use $REGISTRY_NAME \
        --k3s-arg "--disable=traefik@server:0" \
        --kubeconfig-update-default=false \
        -p "80:80@loadbalancer" \
        --wait
  
  STEP kubeconfig
    COMMAND
      mkdir -p .scratch \
        && k3d kubeconfig get $CLUSTER_NAME > .scratch/kubeconfig \
        && KUBECONFIG=.scratch/kubeconfig kubectl config use-context k3d-$CLUSTER_NAME

ARTEFACT stop
  STEP cluster
    CONDITION k3d cluster list | grep -w $CLUSTER_NAME
    COMMAND
      k3d cluster delete $CLUSTER_NAME || true
    
  STEP registry
    CONDITION k3d registry list | grep -w k3d-$REGISTRY_NAME
    COMMAND k3d registry delete $REGISTRY_NAME
  
  STEP scratch
    CONDITION [[ -f .scratch/kubeconfig ]]
    COMMAND rm .scratch/kubeconfig