ENV NPM_REGISTRY=http://localhost:4873

ARTEFACT publish
  STEP install
    CONDITION
      CURRENT=$(npm pack --dry-run 2>&1 | grep shasum | awk '{print $NF}' | tr -d '\n')
      PUBLISHED=$(npm view . dist.shasum)

      echo "checksum: $CURRENT = $PUBLISHED"
      [[ "$CURRENT" != "$PUBLISHED" ]]
    COMMAND npm install

  STEP test
    CONDITION [[ "$DEPS_SKIPPED" != "true" ]]
    COMMAND
      npm run lint
      npm run test
  
  STEP publish
    CONDITION [[ "$DEPS_SKIPPED" != "true" ]]
    COMMAND
      npm version $(npm view . version) --allow-same-version
      npm version patch
      npm publish --registry $NPM_REGISTRY