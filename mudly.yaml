env:
  CLUSTER_NAME: pongle
  REGISTRY_NAME: pongle-registry.localhost
  REGISTRY_PORT: "5000"
artefacts:
- name: generate
  pipeline:
    steps:
    - name: clean
      cmd: |-
        rm -rf infra/manifests/generated
        mkdir -p infra/manifests/generated
    - name: istio
      cmd: |-
        curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.1 sh -
        helm template istio-operator ./istio-1.10.1/manifests/charts/istio-operator --namespace istio-operator > infra/manifests/generated/istio-operator.yaml
        cp ./istio-1.10.1/manifests/charts/istio-operator/crds/* infra/manifests/generated/
        rm -rf istio-1.10.1
    - name: knative
      cmd: |-
        curl -L https://github.com/knative/serving/releases/download/v0.22.0/serving-crds.yaml -o infra/manifests/generated/knative-serving-crds.yaml
        curl -L https://github.com/knative/serving/releases/download/v0.22.0/serving-core.yaml -o infra/manifests/generated/knative-serving-core.yaml
        curl -L https://github.com/knative/net-istio/releases/download/v0.22.0/net-istio.yaml -o infra/manifests/generated/knative-net-istio.yaml
        yq eval-all \
          --inplace \
          '. |= (select(.kind=="Service" and .metadata.name=="knative-local-gateway") | .metadata.labels["experimental.istio.io/disable-gateway-port-translation"]="true")' \
          infra/manifests/generated/knative-net-istio.yaml
- name: start
  pipeline:
    steps:
    - name: registry
      cmd: k3d registry create $REGISTRY_NAME --port $REGISTRY_PORT
    - name: cluster
      cmd: |-
        k3d cluster create $CLUSTER_NAME \
          --registry-use $REGISTRY_NAME \
          --k3s-server-arg "--no-deploy=traefik" \
          --kubeconfig-update-default=false \
          --volume $(pwd)/infra/manifests:/var/lib/rancher/k3s/server/manifests/preload \
          -p "80:80@loadbalancer" \
          --wait
    - name: kubeconfig
      cmd: |-
        mkdir -p .scratch
        k3d kubeconfig get $CLUSTER_NAME > .scratch/kubeconfig
- name: stop
  pipeline:
    steps:
    - name: print
      cmd: |-
        k3d cluster delete $CLUSTER_NAME || true
        k3d registry delete $REGISTRY_NAME || true

        echo "hi"
